<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Wasserzähler App</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #e0f7fa;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      padding: 1rem;
    }
    h1 { color: #006064; margin-bottom: .5rem; }
    #glasses-container {
      display: grid;
      grid-template-columns: repeat(3, 60px);
      gap: 1rem;
      margin: 1rem 0;
    }
    .glass {
      width: 60px; height: 80px;
      border: 3px solid #006064;
      border-radius: 0 0 15px 15px;
      position: relative;
      cursor: pointer;
      overflow: hidden;
      background: #fafafa;
      transition: transform .2s;
    }
    .glass:hover { transform: scale(1.1); }
    .fill {
      position: absolute; bottom: 0; left: 0;
      width: 100%; background: #00bcd4;
      height: 0%; transition: height .3s;
      border-radius: 0 0 12px 12px;
    }
    .glass input {
      position: absolute; top: 0; left: 0;
      width: 100%; height: 100%; border: none;
      font-size: .8rem; text-align: center;
      background: rgba(255,255,255,0.8);
      padding: 0; margin: 0;
    }
    #daily-summary { font-weight: bold; color: #004d40; }
    .btn-group { display: flex; gap: 1rem; margin: 1rem 0; }
    .btn-group button {
      padding: .5rem 1rem; border: none;
      background: #006064; color: #fff;
      border-radius: 5px; cursor: pointer;
      transition: background .2s;
    }
    .btn-group button.active, .btn-group button:hover { background: #004d40; }
  </style>
</head>
<body>
  <h1>Wasserzähler</h1>
  <p id="daily-summary">Heute: 0 Gläser, 0 ml (0.00 L)</p>
  <div id="glasses-container"></div>
  <div id="stats">
    <div class="btn-group">
      <button data-range="week" class="active">Woche</button>
      <button data-range="month">Monat</button>
      <button data-range="year">Jahr</button>
    </div>
    <canvas id="chart"></canvas>
  </div>
  <script>
    const parseVolume = v => {
      const s = (v || '').toLowerCase().replace(',', '.').trim();
      if (s.endsWith('l')) return parseFloat(s) * 1000;
      if (s.endsWith('ml')) return parseFloat(s);
      return parseFloat(s) || 0;
    };
    const formatVolume = ml => {
      const l = ml / 1000;
      return `${ml} ml (${l.toFixed(2)} L)`;
    };
    const todayKey = () => new Date().toLocaleDateString('de-CH');
    const loadVols = () => {
      try {
        const data = JSON.parse(localStorage.getItem(todayKey()));
        return Array.isArray(data) ? data : [];
      } catch {
        return [];
      }
    };
    const saveVols = arr => localStorage.setItem(todayKey(), JSON.stringify(arr));
    const container = document.getElementById('glasses-container');
    let currentRange = 'week';
    let chart;
    const ranges = { week:7, month:30, year:365 };

    function renderGlasses() {
      const vols = loadVols();
      container.innerHTML = '';
      vols.forEach((v, idx) => container.appendChild(createGlass(idx, true)));
      container.appendChild(createGlass(vols.length, false));
    }

    function createGlass(idx, filled) {
      const g = document.createElement('div');
      g.className = 'glass'; g.dataset.idx = idx;
      const fill = document.createElement('div'); fill.className = 'fill';
      g.appendChild(fill);
      if (filled) {
        fill.style.height = '100%';
        g.addEventListener('click', () => removeGlass(idx));
        const tooltip = document.createElement('div');
        tooltip.style.position = 'absolute';
        tooltip.style.top = '2px'; tooltip.style.left = '2px';
        tooltip.style.fontSize = '.6rem';
        tooltip.textContent = formatVolume(loadVols()[idx]);
        g.appendChild(tooltip);
      } else {
        g.addEventListener('click', () => inputGlass(idx));
      }
      return g;
    }

    function removeGlass(idx) {
      const vols = loadVols();
      vols.splice(idx, 1);
      saveVols(vols);
      updateUI();
    }

    function inputGlass(idx) {
      const g = container.children[idx];
      if (g.querySelector('input')) return;
      const input = document.createElement('input');
      input.placeholder = 'z.B. 250ml';
      g.appendChild(input);
      input.focus();
      input.addEventListener('blur', applyInput);
      input.addEventListener('keydown', e => { if (e.key === 'Enter') input.blur(); });
      function applyInput() {
        const val = parseVolume(input.value);
        if (val > 0) {
          const vols = loadVols();
          vols.push(val);
          saveVols(vols);
        }
        updateUI();
      }
    }

    function updateUI() {
      renderGlasses();
      const vols = loadVols();
      const cnt = vols.length;
      const sum = vols.reduce((a, b) => a + b, 0);
      document.getElementById('daily-summary').textContent =
        `Heute: ${cnt} Gläser, ${formatVolume(sum)}`;
      updateChart(currentRange);
    }

    function sumForKey(key) {
      try {
        const arr = JSON.parse(localStorage.getItem(key));
        return Array.isArray(arr) ? arr.reduce((a, b) => a + b, 0) : 0;
      } catch {
        return 0;
      }
    }

    const ctx = document.getElementById('chart').getContext('2d');
    function updateChart(range) {
      const days = ranges[range];
      let total = 0;
      for (let i = days - 1; i >= 0; i--) {
        const d = new Date();
        d.setDate(d.getDate() - i);
        const key = d.toLocaleDateString('de-CH');
        total += sumForKey(key);
      }
      const avg = days ? total / days : 0;
      const label = `Ø pro Tag (${range.charAt(0).toUpperCase() + range.slice(1)})`;
      const labels = [label];
      const data = [Math.round(avg)];
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets: [{ label: 'ml', data }] },
        options: { scales: { y: { beginAtZero: true } } }
      });
    }

    document.querySelectorAll('.btn-group button').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.btn-group button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentRange = btn.dataset.range;
        updateChart(currentRange);
      });
    });

    // Initial load
    updateUI();
  </script>
</body>
</html>
